package main

import (
	"flag"
	"io/fs"
	"log"
	"net/http"
	"os"

	"{{MODULE_NAME}}/internal/config"
	"{{MODULE_NAME}}/internal/database"
	"{{MODULE_NAME}}/internal/server"
	"{{MODULE_NAME}}/web"
)

func main() {
	configPath := flag.String("config", ".local/app.config.yaml", "config file path")
	dev := flag.Bool("dev", false, "dev mode: serve frontend from web/dist on disk")
	flag.Parse()

	cfg, err := config.Load(*configPath)
	if err != nil {
		log.Fatalf("Failed to load config: %v", err)
	}

	log.Printf("{{PROJECT_NAME}} starting")

	// Database
	db, err := database.Open(cfg.Database.Path)
	if err != nil {
		log.Fatalf("Failed to open database: %v", err)
	}
	defer db.Close()

	// Frontend
	var frontendDist fs.FS
	if *dev {
		frontendDist = os.DirFS("web/dist")
		log.Printf("  - Frontend: web/dist (dev mode)")
	} else {
		frontendDist, err = fs.Sub(web.DistFS, "dist")
		if err != nil {
			log.Fatalf("Failed to init frontend: %v", err)
		}
	}

	srv := server.New(frontendDist, db)

	addr := cfg.Address()
	log.Printf("  - Listen: %s", addr)
	log.Printf("Ready!")

	if err := http.ListenAndServe(addr, srv); err != nil {
		log.Fatalf("Server failed: %v", err)
	}
}
